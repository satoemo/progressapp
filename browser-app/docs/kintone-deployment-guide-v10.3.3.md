# kintone進捗管理アプリ v10.3.3 デプロイガイド

最終更新: 2025-10-14

## 概要

このドキュメントは、kintone進捗管理アプリv10.3.3を本番環境（kintone）にデプロイする手順を説明します。

## 前提条件

- Node.js環境がセットアップされていること
- プロジェクトの依存関係がインストールされていること（`npm install`実行済み）
- kintoneアプリの管理者権限を持っていること

## デプロイ方式

v10.3.3では**JavaScript/CSSカスタマイズ方式**を採用しています。

- ビルドされたJavaScript/CSSファイルをkintoneアプリに直接アップロード
- kintoneのレコード一覧画面で自動実行
- HTMLファイルは不要（kintone側が提供）

---

## 1. ビルド手順

### 1-1. 本番用ビルドの実行

```bash
npm run build
```

**出力先:** `dist/browser/`

**生成ファイル:**
- `kintone-progress-app.iife.js` (約5.5MB)
- `style.css` (約71KB)
- `fonts/` (フォントファイル)

### 1-2. ビルド成功の確認

以下のようなメッセージが表示されれば成功です：

```
vite v4.5.14 building for production...
transforming...
✓ 476 modules transformed.
rendering chunks...
computing gzip size...
dist/browser/style.css                        71.34 kB │ gzip:    10.82 kB
dist/browser/kintone-progress-app.iife.js  5,697.35 kB │ gzip: 2,753.60 kB
✓ built in 12.60s
```

### 1-3. ビルドファイルの確認

```bash
ls -lh dist/browser/
```

以下のファイルが存在することを確認：
- kintone-progress-app.iife.js
- style.css
- fonts/ ディレクトリ

---

## 2. kintone環境へのデプロイ

### 2-1. kintoneアプリの設定画面を開く

1. 対象のkintoneアプリを開く
2. 画面右上の⚙️（設定）アイコンをクリック
3. 「設定」→「JavaScript / CSS でカスタマイズ」を選択

### 2-2. ファイルのアップロード

**重要: 必ずこの順序でアップロードしてください**

#### Step 1: CSSファイルのアップロード

1. 「PC用のCSSファイル」セクションで「追加」をクリック
2. `dist/browser/style.css` を選択してアップロード

#### Step 2: JavaScriptファイルのアップロード

1. 「PC用のJavaScriptファイル」セクションで「追加」をクリック
2. `dist/browser/kintone-progress-app.iife.js` を選択してアップロード

**注意事項:**
- ファイルサイズが大きい（5.5MB）ため、アップロードに時間がかかる場合があります
- アップロード中はブラウザを閉じないでください

### 2-3. 設定の保存

1. 画面下部の「保存」ボタンをクリック
2. 「アプリを更新」ボタンをクリック

### 2-4. 運用環境への反映

1. 「設定」タブで「運用環境に反映」ボタンをクリック
2. 確認ダイアログで「はい」をクリック

**反映完了まで数分かかる場合があります。**

---

## 3. 動作確認

### 3-1. 基本動作の確認

1. kintoneアプリのレコード一覧画面を開く
2. ページが読み込まれると、ヘッダー部分にアプリUIが表示される
3. タブ切り替えが動作することを確認
   - 進捗管理
   - 担当者別
   - シミュレーション
   - リテイク

### 3-2. データ保存の確認

1. 適当なデータを入力
2. 画面をリロード
3. 入力したデータが保持されていることを確認

### 3-3. エラーログの確認

ブラウザのコンソールを開き、以下を確認：

```javascript
// 初期化完了メッセージが表示されること
// "KintoneProgressAppV10.3 initialized successfully in kintone environment"

// エラーがないこと（赤色のメッセージがないこと）
```

---

## 4. トラブルシューティング

### 4-1. アプリが表示されない

**症状:** ヘッダー部分にアプリUIが表示されない

**確認事項:**
1. ブラウザのコンソールでエラーを確認
2. JavaScriptファイルが正しくアップロードされているか確認
3. 設定が「運用環境に反映」されているか確認

**解決方法:**
- ブラウザキャッシュをクリアしてリロード（Ctrl+Shift+R / Cmd+Shift+R）
- JavaScriptファイルを再アップロード

### 4-2. スタイルが崩れる

**症状:** レイアウトが正しく表示されない

**確認事項:**
1. CSSファイルが正しくアップロードされているか確認
2. ファイルアップロード順序が正しいか確認（CSS → JavaScript）

**解決方法:**
- CSSファイルを再アップロード
- ブラウザキャッシュをクリア

### 4-3. "Container not found" エラー

**症状:** コンソールに "Container not found" エラーが表示される

**原因:** kintone環境の初期化に失敗している

**解決方法:**
1. ビルドファイルが破損していないか確認
2. 再ビルドして再デプロイ

### 4-4. データが保存されない

**症状:** 入力したデータがリロード後に消える

**確認事項:**
1. コンソールでEventStoreのエラーを確認
2. kintoneレコードが作成されているか確認

**解決方法:**
- kintoneアプリの権限設定を確認
- レコードの作成・更新権限があるか確認

---

## 5. ロールバック手順

問題が発生した場合、以前のバージョンに戻すことができます。

### 5-1. バックアップファイルの確認

過去のビルドファイルは `archive/` ディレクトリに保存されています：

```bash
ls -lh archive/
```

### 5-2. ロールバックの実行

1. kintoneアプリの設定画面を開く
2. 「JavaScript / CSS でカスタマイズ」を選択
3. 現在のファイルを削除
4. archive/ の旧バージョンファイルをアップロード
5. 設定を保存して運用環境に反映

---

## 6. バージョン管理

### 6-1. デプロイ前のバックアップ

**重要:** 新バージョンをデプロイする前に、必ず現在のファイルをバックアップしてください。

```bash
# 現在のビルドファイルをarchiveに保存
cp dist/browser/kintone-progress-app.iife.js archive/kintone-progress-app-$(date +%Y%m%d-%H%M).iife.js
cp dist/browser/style.css archive/style-$(date +%Y%m%d-%H%M).css
```

### 6-2. デプロイ履歴の記録

デプロイ時には以下の情報を記録することを推奨します：

- デプロイ日時
- バージョン番号
- 変更内容の概要
- デプロイ担当者

---

## 7. 開発環境とテスト環境

### 7-1. ローカルテスト環境

本番デプロイ前に、ローカル環境でテストすることを推奨します：

```bash
# テスト用ビルド
npm run build:test

# テストHTMLを開く
# test/test-api-mock.html をブラウザで開く
```

### 7-2. テスト環境の特徴

- ビルドファイルは圧縮されていない（デバッグしやすい）
- ソースマップ付き
- モックAPIを使用（kintone APIを使用しない）

---

## 8. パフォーマンス

### 8-1. ビルドファイルサイズ

| ファイル | サイズ | gzip圧縮後 |
|---------|--------|-----------|
| kintone-progress-app.iife.js | 5.5MB | 2.7MB |
| style.css | 71KB | 11KB |

### 8-2. 初期化時間

- 通常: 1-2秒
- 初回アクセス（キャッシュなし）: 3-5秒

### 8-3. 最適化のヒント

本番ビルドでは以下の最適化が適用されています：
- Terserによるコード圧縮
- TreeShaking（未使用コードの削除）
- コメント削除

---

## 9. セキュリティ考慮事項

### 9-1. 認証

- kintoneのセッション認証を使用
- APIトークンは不要
- ユーザー権限はkintoneアプリの権限設定に従う

### 9-2. データ保存

- kintoneレコードとしてデータを保存
- LocalStorageも併用（キャッシュ目的）
- 機密情報は含まれていない

---

## 10. サポートとフィードバック

問題が発生した場合は、以下の情報を提供してください：

1. ブラウザの種類とバージョン
2. kintoneのバージョン
3. コンソールのエラーメッセージ
4. 再現手順

---

## 付録A: ビルドスクリプト一覧

```json
{
  "build": "本番用ビルド（kintoneデプロイ用）",
  "build:test": "テスト用ビルド（ローカル開発用）",
  "build:watch": "ファイル変更を監視して自動ビルド",
  "typecheck": "TypeScriptの型チェックのみ実行",
  "dev": "開発サーバー起動"
}
```

## 付録B: 環境判定ロジック

アプリは実行環境を自動判定します：

- **kintone環境**: `window.kintone` が存在する場合
  - KintoneEventStoreを使用（kintoneレコードに保存）

- **ローカル環境**: `window.kintone` が存在しない場合
  - LocalStorageEventStoreを使用（ブラウザに保存）

## 付録C: チェックリスト

デプロイ前のチェックリスト：

- [ ] `npm run build` が正常に完了した
- [ ] dist/browser/ にファイルが生成された
- [ ] 過去のビルドをarchiveにバックアップした
- [ ] kintoneアプリの管理者権限を確認した
- [ ] CSS → JavaScript の順でアップロードした
- [ ] 設定を保存し、運用環境に反映した
- [ ] ブラウザで動作確認を実施した
- [ ] コンソールにエラーがないことを確認した
