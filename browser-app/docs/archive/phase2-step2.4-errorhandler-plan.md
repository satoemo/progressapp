# Phase 2 Step 2.4: ErrorHandler活用拡大計画

## 実施日
2025年9月12日

## 現状分析
- ErrorHandler.handleは既に98箇所で使用中
- まだ20ファイルでtry-catchが直接使用されている
- エラーハンドリングのパターンが統一されていない箇所が存在

## 目的
1. エラーハンドリングの完全統一
2. エラーログの一元管理
3. エラー頻度の監視とレポート機能の追加
4. リトライ機能の活用促進

## 実装計画

### 段階的実装単位

#### 第1段階: 高頻度使用ファイルのtry-catch置き換え（推奨）
**対象ファイル（10ファイル）:**
1. ProgressTable.ts - テーブル表示の中核
2. BaseProgressTable.ts - 基底クラス
3. UnifiedDataStore.ts - データストア
4. MockKintoneApiClient.ts - APIモック
5. NormaDataService.ts - ノルマデータ管理
6. SimplifiedReadModel.ts - 読み取りモデル
7. StateManagerService.ts - 状態管理
8. PDFExportService.ts - PDF出力
9. UnifiedEventCoordinator.ts - イベント調整
10. ViewStateManager.ts - ビュー状態管理

**置き換えパターン:**
```typescript
// Before
try {
  // 処理
} catch (error) {
  console.error('エラー:', error);
  // エラー処理
}

// After
ErrorHandler.handle(error, 'コンテキスト名', {
  logLevel: 'error',
  customMessage: 'カスタムメッセージ',
  fallback: デフォルト値
});
```

#### 第2段階: ErrorHandlerの機能拡張
1. **エラー分類機能の追加**
   - ネットワークエラー
   - バリデーションエラー
   - 権限エラー
   - システムエラー

2. **エラーレポート機能**
   - エラー頻度の統計
   - エラーパターンの分析
   - 定期レポートの生成

3. **リトライ機能の改善**
   - 指数バックオフの実装
   - 最大リトライ回数の管理
   - リトライ可能エラーの判定

#### 第3段階: エラーメッセージの改善
1. ユーザー向けメッセージの統一
2. 開発者向けログの充実
3. エラーコードの体系化

## 実装優先順位
1. **高優先度**: 第1段階のtry-catch置き換え
2. **中優先度**: エラー分類機能の追加
3. **低優先度**: レポート機能とメッセージ改善

## 期待される効果
1. **保守性向上**: エラー処理の一元管理
2. **デバッグ効率化**: 詳細なエラーログ
3. **品質向上**: エラーパターンの把握と改善
4. **ユーザー体験向上**: 適切なエラーメッセージ

## テスト項目
1. エラーが正しくログに記録されること
2. fallback値が正しく返されること
3. リトライ機能が動作すること
4. エラー頻度が記録されること
5. UIの動作に影響がないこと

## リスクと対策
- **リスク**: 既存のエラー処理ロジックの変更による予期しない動作
- **対策**: 段階的実装と各段階でのテスト実施

## 実装スケジュール
- 第1段階: 30分（10ファイル、各3分）
- 第2段階: 20分（機能拡張）
- 第3段階: 10分（メッセージ改善）

## 成功基準
1. ビルドエラーなし
2. 既存機能の動作に影響なし
3. エラーログの出力確認
4. try-catch使用箇所の50%以上削減

---
この計画で進めてよろしいですか？