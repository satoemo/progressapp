# リファクタリング要件定義 - v10.4.0 - 2025-08

## プロジェクト概要

現在のv10.3.3から、大規模リファクタリングを実施してv10.4.0を作成する。
Event Sourcing + CQRSアーキテクチャから軽量イベントシステムへの移行と、
場当たり的な修正によるコード品質問題の根本的解決を目指す。

## 要件定義（質問回答記録）

### 1. スケジュール・リソース
**Q: リファクタリングの期間、工数配分、段階的リリースについて**

A: 
- **期間**: 3ヶ月を想定
- **優先度**: このリファクタリングを最優先で実施
- **バージョン**: v10.4.0として作業
- **リリース**: 段階的リリース可能（公開していないため）

### 2. 影響範囲・優先度
**Q: 稼働中機能、ユーザー影響、後方互換性について**

A:
- **最重要機能**: 進捗管理表（あらゆる処理でここの入力情報を使用）
- **機能停止**: いつでも可能（公開していないため）
- **UI制約**: 進捗管理表のUIは変更しない、それ以外は変更可能
- **互換性**: 現在ダミーデータのみのため気にしなくてよい

### 3. 現状問題の把握
**Q: 場当たり的修正、最も困っている問題、テスト状況について**

A:
- **型の不統一**: string/booleanなどの型が統一されていない（「一貫性」に反する）
- **複雑なバグ修正**: 複数階層にまたがるバグ修正に時間を取られている
- **イベント優先度問題**: イベントの優先度に起因するバグに時間を取られている

### 4. 技術的制約
**Q: kintone制約、データ移行、外部依存について**

A:
- **kintone制約**: 特に考慮事項なし、現在のAPI処理で問題なく動作
- **データ移行**: 現在のデータは無視可能
- **外部依存**: 特になし、このプロジェクトで完結

## リファクタリング目標

### 主要目標
1. **場当たり的なコードの修正**: 根本的な設計見直し
2. **シンプルな階層構造**: Event Sourcing + CQRSからの移行
3. **軽量イベントシステム**: 複雑なイベントフローの簡素化
4. **コード品質向上**: 「一貫性」「重複なし」「シンプル」の実現

### 具体的成果物
1. **型の統一**: すべての削除状態をboolean型で統一
2. **階層の簡素化**: 6層以上のフローを3層程度に削減
3. **デバッグ容易性**: 線形に追跡可能なデータフロー
4. **保守性向上**: 新機能追加時の影響範囲の明確化

## 制約条件

### 変更禁止
- 進捗管理表のUI（最重要機能のため）

### 変更可能
- アーキテクチャ全体
-内部実装
- データ構造
- その他のUI

### 優先順位
1. 進捗管理表機能の完全保持
2. 既存機能の完全再現
3. コード品質の向上
4. 開発生産性の向上

## 次ステップ

1. **現状調査**: 詳細なコード分析とアーキテクチャ調査
2. **詳細計画策定**: フェーズ分けとマイルストーン設定
3. **段階的実装**: リスクを最小化した移行戦略
4. **品質保証**: 各フェーズでの動作確認とテスト

本文書を基に、具体的なリファクタリング実行計画を策定する。