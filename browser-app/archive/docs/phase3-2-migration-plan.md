# Phase 3.2からの段階的移行計画

## 現在の状態（Phase 3.2）
- **アーキテクチャ**: Event Sourcing + CQRS パターン
- **レイヤー構造**: 6層アーキテクチャ
  - domain（集約、値オブジェクト、イベント）
  - application（コマンド、クエリ、サービス）
  - infrastructure（リポジトリ、イベントストア）
  - ui（ビューコンポーネント）
  - core（共通イベント管理）
  - utils（ユーティリティ）

## 移行の目標
Event Sourcing/CQRSから簡素化された3層アーキテクチャへの段階的な移行

## Phase 3.2-A: 準備フェーズ（1週間）

### 目的
移行のための基盤整備と現状把握

### タスク
1. **現在のビジネスロジックの抽出**
   - CommandHandler内のビジネスロジックを文書化
   - 検証ルールの一覧化
   - イベント処理フローの整理

2. **統合テストの作成**
   - 主要な操作フローのE2Eテスト作成
   - パフォーマンステスト作成
   - データ整合性チェックテスト作成

3. **移行用のアダプタレイヤー作成**
   ```typescript
   // ApplicationServiceAdapter.ts
   class ApplicationServiceAdapter {
     // 新旧インターフェースの橋渡し
   }
   ```

## Phase 3.2-B: データレイヤーの並行実装（2週間）

### 目的
新しいデータレイヤーを既存システムと並行して動作させる

### タスク
1. **シンプルなデータモデルの作成**
   ```typescript
   // src/data/models/CutModel.ts
   interface CutModel {
     id: string;
     cutNumber: string;
     // ... Event Sourcingを使わないシンプルな構造
   }
   ```

2. **データストアの実装**
   ```typescript
   // src/data/stores/CutStore.ts
   class CutStore {
     // ReadModelStoreと同じインターフェース
     // 内部実装はシンプル化
   }
   ```

3. **データ同期メカニズムの実装**
   - Event StoreからCutStoreへのデータ同期
   - 双方向のデータ整合性保証

## Phase 3.2-C: サービスレイヤーの段階的移行（2週間）

### 目的
CommandBus/QueryBusから直接的なサービス呼び出しへの移行

### タスク
1. **CutServiceの実装**
   - CommandHandlerのロジックを移植
   - CommandBusとの互換性維持

2. **MemoServiceの実装**
   - メモ機能の簡素化
   - 既存のMemoAggregateとの共存

3. **AppServiceファサードの作成**
   - UIからの統一インターフェース
   - 新旧サービスの切り替え機能

## Phase 3.2-D: UIレイヤーの適応（1週間）

### 目的
UIコンポーネントを新しいサービスレイヤーに接続

### タスク
1. **ProgressTableの更新**
   - AppServiceへの依存注入
   - CommandBus使用箇所の段階的置き換え

2. **ポップアップコンポーネントの更新**
   - 直接的なサービス呼び出しに変更
   - エラーハンドリングの改善

## Phase 3.2-E: Event Sourcingの段階的削除（1週間）

### 目的
Event Sourcing関連のコードを安全に削除

### タスク
1. **不要なイベントクラスの削除**
   - DomainEventの削除
   - EventStoreの削除

2. **Aggregateパターンの簡素化**
   - EventSourcedAggregateRootの削除
   - シンプルなエンティティへの変換

## Phase 3.2-F: 最終統合とクリーンアップ（1週間）

### 目的
移行の完了と不要コードの削除

### タスク
1. **旧アーキテクチャコードの削除**
   - CommandBus/QueryBusの削除
   - 不要なHandlerクラスの削除

2. **パフォーマンスチューニング**
   - 新アーキテクチャでの最適化
   - メモリ使用量の削減

3. **ドキュメントの更新**
   - アーキテクチャガイドの更新
   - APIドキュメントの作成

## リスク管理

### 段階的ロールバック戦略
各フェーズで以下を確保：
- **Feature Flag**: 新旧切り替え可能
- **データバックアップ**: 各フェーズ前にスナップショット
- **並行稼働期間**: 最低1週間の検証期間

### 成功指標
- **パフォーマンス**: 現行の2倍以上の高速化
- **メモリ使用量**: 50%削減
- **コード行数**: 30%削減
- **ビルドサイズ**: 20%削減

## タイムライン

| フェーズ | 期間 | 開始日 | 終了日 |
|---------|------|--------|--------|
| Phase 3.2-A | 1週間 | 8/22 | 8/28 |
| Phase 3.2-B | 2週間 | 8/29 | 9/11 |
| Phase 3.2-C | 2週間 | 9/12 | 9/25 |
| Phase 3.2-D | 1週間 | 9/26 | 10/2 |
| Phase 3.2-E | 1週間 | 10/3 | 10/9 |
| Phase 3.2-F | 1週間 | 10/10 | 10/16 |

## 注意事項

1. **ビジネスロジックの保持**
   - CommandHandler内のすべての検証ロジックを新サービスに移植
   - ドメインルールを文書化してから削除

2. **互換性の維持**
   - 各フェーズで既存機能が動作することを確認
   - UIの挙動を変更しない

3. **段階的な検証**
   - 各フェーズ完了時に全機能テスト実施
   - パフォーマンステスト実施
   - ユーザー受け入れテスト実施